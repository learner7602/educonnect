<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Class V Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div id="loader" class="flex items-center justify-center h-screen">Loading...</div>
  <div id="dashboard" class="hidden p-4">
    <h1 class="text-2xl font-bold mb-4">Welcome, <span id="studentName"></span></h1>
    <button id="signOutBtn" class="px-4 py-2 bg-red-500 text-white rounded">Sign Out</button>
    <div class="mt-6">
      <h2 class="text-xl font-semibold">Live Class</h2>
      <p id="liveClassStatus" class="text-gray-600">Loading live class...</p>
      <a id="joinClassBtn" href="#" class="mt-2 inline-block px-4 py-2 bg-blue-500 text-white rounded disabled">Join Class</a>
    </div>
    <div class="mt-6">
      <h2 class="text-xl font-semibold">Resources</h2>
      <ul id="resourcesList" class="list-disc ml-6 text-blue-600"></ul>
    </div>
  </div>

  <script>
    // Firebase config (replace with your own)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loader = document.getElementById("loader");
    const dashboard = document.getElementById("dashboard");
    const studentName = document.getElementById("studentName");
    const signOutBtn = document.getElementById("signOutBtn");
    const joinClassBtn = document.getElementById("joinClassBtn");
    const liveClassStatus = document.getElementById("liveClassStatus");
    const resourcesList = document.getElementById("resourcesList");

    const CLASS_ID = "Class-V";

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        loader.style.display = "none";
        dashboard.classList.remove("hidden");

        // Load student profile
        try {
          const userDoc = await db.collection(CLASS_ID).doc(user.uid).get();
          studentName.textContent = userDoc.exists
            ? (userDoc.data().fullName || user.email)
            : user.email;
        } catch (err) {
          console.error("Profile load error:", err.message);
          studentName.textContent = user.email;
        }

        // Live class listener
        try {
          db.collection(CLASS_ID).doc("liveClass").onSnapshot(
            (doc) => {
              if (doc.exists && doc.data().link) {
                joinClassBtn.href = doc.data().link;
                joinClassBtn.target = "_blank";
                joinClassBtn.classList.remove("disabled");
                liveClassStatus.textContent = "‚úÖ Live class is available!";
              } else {
                joinClassBtn.href = "#";
                joinClassBtn.classList.add("disabled");
                liveClassStatus.textContent = "‚ö†Ô∏è No live class link yet.";
              }
            },
            (err) => {
              console.error("Live class listener error:", err.message);
              liveClassStatus.textContent = "‚ö†Ô∏è Cannot load live class.";
            }
          );
        } catch (err) {
          console.error("Live class setup error:", err.message);
        }

        // Resources listener
        try {
          db.collection(CLASS_ID).doc("resources").collection("items").orderBy("uploadedAt", "desc")
            .onSnapshot(
              (snapshot) => {
                resourcesList.innerHTML = "";
                if (snapshot.empty) {
                  resourcesList.innerHTML = "<li class='text-gray-500'>No resources yet.</li>";
                } else {
                  snapshot.forEach(doc => {
                    const r = doc.data();
                    resourcesList.innerHTML += `<li><a href="${r.link}" target="_blank" class="resource-link">üìò ${r.title}</a></li>`;
                  });
                }
              },
              (err) => {
                console.error("Resources listener error:", err.message);
                resourcesList.innerHTML = "<li class='text-red-500'>‚ö†Ô∏è Cannot load resources.</li>";
              }
            );
        } catch (err) {
          console.error("Resources setup error:", err.message);
        }

      } else {
        loader.style.display = "flex";
        dashboard.classList.add("hidden");
      }
    });

    signOutBtn.addEventListener("click", async () => {
      await auth.signOut();
      window.location.href = "index.html";
    });
  </script>
</body>
</html>

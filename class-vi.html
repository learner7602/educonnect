<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Class VI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8f9fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #333;
    }
    header {
      background-image: linear-gradient(to right, #2c5282, #38a169);
      color: white;
      padding: 1.5rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 50;
    }
    h1 {
      font-size: 2rem;
      font-weight: 700;
    }
    main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
    }
    .welcome-message {
      font-size: 2.25rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 2rem;
    }
    .dashboard-buttons {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      width: 100%;
      max-width: 300px;
    }
    .dashboard-button {
      padding: 1.5rem 1rem;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 1.25rem;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .dashboard-button.blue {
      background-color: #4299e1;
    }
    .dashboard-button.blue:hover:not(.disabled) {
      background-color: #3182ce;
      transform: translateY(-3px);
    }
    .dashboard-button.green {
      background-color: #48bb78;
    }
    .dashboard-button.green:hover:not(.disabled) {
      background-color: #38a169;
      transform: translateY(-3px);
    }
    .dashboard-button.disabled {
      background-color: #a0aec0;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    #signout {
      background-color: #e53e3e;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #signout:hover {
      background-color: #c53030;
    }

    /* Account Dropdown Styles */
    .account-dropdown {
      position: relative;
      display: inline-block;
      margin-left: 1rem;
    }
    .account-button {
      background-color: #50E3C2;
      color: #333;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .account-button:hover {
      background-color: #38c1a1;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 180px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.25);
      z-index: 100;
      border-radius: 0.5rem;
      right: 0;
      top: 100%;
      margin-top: 0.75rem;
      border: 1px solid #e2e8f0;
    }
    .dropdown-content a {
      color: #333;
      padding: 12px 20px;
      text-decoration: none;
      display: block;
      text-align: left;
      transition: background-color 0.2s ease, color 0.2s ease;
      border-radius: 0.4rem;
    }
    .dropdown-content a:hover {
      background-color: var(--primary-color);
      color: white;
    }
    .account-dropdown.open .dropdown-content {
      display: block;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 2.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      text-align: left;
      position: relative;
    }
    .modal-close-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #718096;
    }
    .modal-close-button:hover {
      color: #2d3748;
    }
    .modal-content h2 {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .profile-info p {
      margin-bottom: 0.75rem;
      font-size: 1.05rem;
      color: #4a5568;
    }
    .profile-info strong {
      color: #2d3748;
      display: inline-block;
      width: 120px;
    }
    .pay-fees-button {
      background-color: #48bb78;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      width: 100%;
      transition: background-color 0.3s ease;
      margin-top: 1.5rem;
    }
    .pay-fees-button:hover {
      background-color: #38a169;
    }
    .fee-status-message {
      margin-top: 1rem;
      font-weight: 600;
      color: #e53e3e;
      text-align: center;
    }
    .fee-status-message.paid {
      color: #38a169;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      h1 {
        font-size: 1.75rem;
      }
      .welcome-message {
        font-size: 1.75rem;
      }
      .modal-content {
        padding: 1.5rem;
      }
    }
  </style>
  <!-- Razorpay SDK (will be loaded conditionally in JS for real integration) -->
  <!-- <script src="https://checkout.razorpay.com/v1/checkout.js"></script> -->
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-700 to-green-600 text-white py-4 px-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold">Class VI Dashboard</h1>
    <div class="flex items-center space-x-4">
      <!-- Account Dropdown -->
      <div class="account-dropdown" id="accountDropdown">
        <button class="account-button">Account</button>
        <div class="dropdown-content">
          <a href="#" id="viewProfileBtn">View Profile</a>
          <a href="#" id="payFeesBtn">Pay Fees</a>
          <a href="#" id="lastReceiptBtn">Last Fees Receipt</a>
        </div>
      </div>
      <button id="signout" class="bg-red-500 text-white px-4 py-2 rounded">Sign Out</button>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-grow flex flex-col items-center justify-center space-y-6">
    <h2 id="welcome-message" class="text-3xl font-bold text-gray-800">Welcome, Student</h2>
    <div class="dashboard-buttons">
      <button class="dashboard-button blue" id="joinClassBtn">Join Class</button>
      <button class="dashboard-button green" id="resourcesBtn">Resources</button>
    </div>
    <p id="fee-status-alert" class="fee-status-message hidden"></p>
  </main>

  <!-- View Profile Modal -->
  <div id="profileModal" class="modal-overlay hidden">
    <div class="modal-content">
      <button class="modal-close-button" id="closeProfileModal">&times;</button>
      <h2>Your Profile</h2>
      <div id="profileInfo" class="profile-info">
        <!-- Profile data will be inserted here by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Pay Fees Modal -->
  <div id="payFeesModal" class="modal-overlay hidden">
    <div class="modal-content">
      <button class="modal-close-button" id="closePayFeesModal">&times;</button>
      <h2>Pay Monthly Fees</h2>
      <p class="text-gray-700 mb-4 text-center">Your current fee status: <span id="currentFeeStatus" class="font-bold"></span></p>
      <button id="razorpayPaymentBtn" class="pay-fees-button">Pay with Razorpay (Simulated)</button>
      <p id="paymentMessage" class="fee-status-message hidden"></p>
      <div class="mt-4 p-3 bg-gray-100 rounded-md text-sm text-gray-700">
        <p class="font-semibold text-lg">Razorpay Integration Details:</p>
        <p class="mt-2">To integrate **Razorpay** for real payments, you would typically follow these steps:</p>
        <ul class="list-disc list-inside ml-4">
          <li>**Backend Order Creation**: Your server (backend) must create a Razorpay Order to get an `order_id`. This is crucial for security.</li>
          <li>**Load Razorpay SDK**: Dynamically load `<script src="https://checkout.razorpay.com/v1/checkout.js"></script>` in your page or ensure it's loaded.</li>
          <li>**Initialize Razorpay Options**:
            <pre class="bg-gray-200 p-2 rounded-md text-xs mt-2 overflow-x-auto"><code>const options = {
  key: "YOUR_RAZORPAY_KEY_ID",
  amount: "50000",
  currency: "INR",
  name: "EduConnect Fees",
  description: "Monthly Class VI Fees",
  order_id: "ORDERID_FROM_YOUR_BACKEND",
  handler: function (response) {
    const paymentDetails = {
      razorpay_payment_id: response.razorpay_payment_id,
      razorpay_order_id: response.razorpay_order_id,
      razorpay_signature: response.razorpay_signature,
      amount: options.amount,
      currency: options.currency,
      date: firebase.firestore.FieldValue.serverTimestamp(),
      status: "success",
      month: new Date().toLocaleString('default', { month: 'long' }),
      year: new Date().getFullYear()
    };
    storePaymentRecordInFirestore(paymentDetails);
  },
  prefill: {
    name: "Student Name (from profile)",
    email: "student@example.com (from profile)",
    contact: "9876543210 (from profile)"
  },
  notes: {
    address: "Student Address"
  },
  theme: {
    color: "#4A90E2"
  }
};</code></pre>
          </li>
          <li>**Open Razorpay Checkout**: `const rzp1 = new Razorpay(options); rzp1.open();`</li>
          <li>**Error Handling**: Implement `rzp1.on('payment.failed', function (response){...})` to handle payment failures.</li>
        </ul>
        <p class="mt-2 text-red-600 font-semibold">Security Warning: Never expose your Razorpay API `key_secret` on the client-side. All order creation and payment verification should happen securely on your backend server.</p>
      </div>
    </div>
  </div>

  <!-- Last Fees Receipt Modal -->
  <div id="lastReceiptModal" class="modal-overlay hidden">
    <div class="modal-content">
      <button class="modal-close-button" id="closeLastReceiptModal">&times;</button>
      <h2>Last Fees Receipt</h2>
      <div id="receiptInfo" class="profile-info">
        <!-- Receipt data will be inserted here by JavaScript -->
      </div>
    </div>
  </div>


  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyApjKA34mwvz_gWH9V0RY4wHbmMEP6oqRg",
      authDomain: "educonnectapp-ae08d.firebaseapp.com",
      projectId: "educonnectapp-ae08d",
      storageBucket: "educonnectapp-ae08d.appspot.com",
      messagingSenderId: "10974354104",
      appId: "1:10974354104:web:228ca789dfb241f43ff24d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const FieldValue = firebase.firestore.FieldValue;

    const classId = "VI"; // !!! IMPORTANT: Changed classId for Class VI !!!

    const joinClassBtn = document.getElementById('joinClassBtn');
    const resourcesBtn = document.getElementById('resourcesBtn');
    const feeStatusAlert = document.getElementById('fee-status-alert');

    const accountDropdown = document.getElementById('accountDropdown');
    const accountButton = accountDropdown.querySelector('.account-button');
    const dropdownContent = accountDropdown.querySelector('.dropdown-content');

    const profileModal = document.getElementById('profileModal');
    const closeProfileModalBtn = document.getElementById('closeProfileModal');
    const profileInfoDiv = document.getElementById('profileInfo');

    const payFeesModal = document.getElementById('payFeesModal');
    const closePayFeesModalBtn = document.getElementById('closePayFeesModal');
    const razorpayPaymentBtn = document.getElementById('razorpayPaymentBtn');
    const paymentMessage = document.getElementById('paymentMessage');
    const currentFeeStatusSpan = document.getElementById('currentFeeStatus');

    const lastReceiptModal = document.getElementById('lastReceiptModal');
    const closeLastReceiptModalBtn = document.getElementById('closeLastReceiptModal');
    const receiptInfoDiv = document.getElementById('receiptInfo');


    const checkPaymentStatus = async (userUid) => {
      const userDocRef = db.collection(`Class-${classId}`).doc(userUid);
      const userDoc = await userDocRef.get();

      if (userDoc.exists && userDoc.data().payments && userDoc.data().payments.length > 0) {
        const allPayments = userDoc.data().payments;
        allPayments.sort((a, b) => b.date.toDate().getTime() - a.date.toDate().getTime());
        const lastPayment = allPayments[0];

        const lastPaymentDate = lastPayment.date.toDate();
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();

        if (lastPaymentDate.getMonth() === currentMonth && lastPaymentDate.getFullYear() === currentYear) {
            return true;
        }
      }
      return false;
    };

    const updateAccessUI = (hasPaid) => {
      if (hasPaid) {
        joinClassBtn.classList.remove('disabled');
        joinClassBtn.disabled = false;
        resourcesBtn.classList.remove('disabled');
        resourcesBtn.disabled = false;
        feeStatusAlert.classList.add('hidden');
        feeStatusAlert.classList.remove('error', 'paid');
      } else {
        joinClassBtn.classList.add('disabled');
        joinClassBtn.disabled = true;
        resourcesBtn.classList.add('disabled');
        resourcesBtn.disabled = true;
        feeStatusAlert.classList.remove('hidden');
        feeStatusAlert.classList.add('error');
        feeStatusAlert.innerText = "Fees not paid for the current month. Please pay to access content.";
      }
    };

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        const docRef = db.collection(`Class-${classId}`).doc(user.uid);
        const doc = await docRef.get();

        if (doc.exists) {
          let userName = doc.data().fullName || user.email;
          document.getElementById("welcome-message").innerText = `Welcome, ${userName}`;
          const hasPaid = await checkPaymentStatus(user.uid);
          updateAccessUI(hasPaid);
        } else {
          await auth.signOut();
          window.location.href = "index.html";
        }
      }
    });

    document.getElementById("signout").addEventListener("click", async () => {
      await auth.signOut();
      window.location.href = "index.html";
    });

    accountButton.addEventListener('click', () => {
      accountDropdown.classList.toggle('open');
    });

    window.addEventListener('click', (event) => {
      if (!accountDropdown.contains(event.target)) {
        accountDropdown.classList.remove('open');
      }
    });

    const storePaymentRecordInFirestore = async (paymentDetails) => {
        const user = auth.currentUser;
        if (user) {
            const userDocRef = db.collection(`Class-${classId}`).doc(user.uid);
            try {
                await userDocRef.update({
                    payments: FieldValue.arrayUnion(paymentDetails)
                });
                console.log("Payment record stored in Firestore.");
                paymentMessage.classList.remove('hidden', 'error');
                paymentMessage.classList.add('paid');
                paymentMessage.innerText = "Payment successful! Access granted.";
                razorpayPaymentBtn.disabled = true;
                razorpayPaymentBtn.classList.add('disabled');
                
                const hasPaid = await checkPaymentStatus(user.uid);
                updateAccessUI(hasPaid);
                const today = new Date();
                const currentMonth = today.toLocaleString('default', { month: 'long' });
                const currentYear = today.getFullYear();
                currentFeeStatusSpan.innerHTML = `<span class="text-green-600">Paid for ${currentMonth} ${currentYear}</span>`;

            } catch (error) {
                console.error("Error storing payment record: ", error);
                paymentMessage.classList.remove('hidden', 'paid');
                paymentMessage.classList.add('error');
                paymentMessage.innerText = `Error storing payment: ${error.message}`;
            }
        }
    };


    document.getElementById('viewProfileBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      accountDropdown.classList.remove('open');
      const user = auth.currentUser;
      if (user) {
        const docRef = db.collection(`Class-${classId}`).doc(user.uid);
        const doc = await docRef.get();
        if (doc.exists) {
          const userData = doc.data();
          profileInfoDiv.innerHTML = `
            <p><strong>Full Name:</strong> ${userData.fullName || 'N/A'}</p>
            <p><strong>Father's Name:</strong> ${userData.fatherName || 'N/A'}</p>
            <p><strong>School Name:</strong> ${userData.schoolName || 'N/A'}</p>
            <p><strong>Address:</strong> ${userData.address || 'N/A'}</p>
            <p><strong>Mobile:</strong> ${userData.phone || 'N/A'}</p>
            <p><strong>Email:</strong> ${userData.email || 'N/A'}</p>
            <p><strong>Registered On:</strong> ${userData.createdAt ? userData.createdAt.toDate().toLocaleDateString() : 'N/A'}</p>
          `;
          profileModal.classList.remove('hidden');
        } else {
          feeStatusAlert.classList.remove('hidden', 'paid');
          feeStatusAlert.classList.add('error');
          feeStatusAlert.innerText = "Could not retrieve profile data. Please try again.";
        }
      }
    });

    closeProfileModalBtn.addEventListener('click', () => {
      profileModal.classList.add('hidden');
    });

    document.getElementById('payFeesBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      accountDropdown.classList.remove('open');
      const user = auth.currentUser;
      if (user) {
        const hasPaid = await checkPaymentStatus(user.uid);
        const today = new Date();
        const currentMonth = today.toLocaleString('default', { month: 'long' });
        const currentYear = today.getFullYear();

        if (hasPaid) {
          currentFeeStatusSpan.innerHTML = `<span class="text-green-600">Paid for ${currentMonth} ${currentYear}</span>`;
          razorpayPaymentBtn.disabled = true;
          razorpayPaymentBtn.classList.add('disabled');
          paymentMessage.classList.remove('hidden', 'error');
          paymentMessage.classList.add('paid');
          paymentMessage.innerText = `You have already paid for ${currentMonth}.`;
        } else {
          currentFeeStatusSpan.innerHTML = `<span class="text-red-600">Unpaid for ${currentMonth} ${currentYear}</span>`;
          razorpayPaymentBtn.disabled = false;
          razorpayPaymentBtn.classList.remove('disabled');
          paymentMessage.classList.add('hidden');
        }
        payFeesModal.classList.remove('hidden');
      }
    });

    razorpayPaymentBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (user) {
        paymentMessage.classList.remove('hidden', 'paid', 'error');
        paymentMessage.innerText = "Initiating payment...";
        
        setTimeout(() => {
            const simulatedPaymentId = 'pay_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            const simulatedOrderId = 'order_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            const simulatedAmount = 50000;

            const paymentDetails = {
                paymentId: simulatedPaymentId,
                orderId: simulatedOrderId,
                amount: simulatedAmount,
                currency: "INR",
                date: FieldValue.serverTimestamp(),
                status: "success",
                month: new Date().toLocaleString('default', { month: 'long' }),
                year: new Date().getFullYear()
            };
            storePaymentRecordInFirestore(paymentDetails);
        }, 1500);
      }
    });

    closePayFeesModalBtn.addEventListener('click', () => {
      payFeesModal.classList.add('hidden');
      paymentMessage.classList.add('hidden');
    });

    document.getElementById('lastReceiptBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      accountDropdown.classList.remove('open');
      const user = auth.currentUser;
      if (user) {
        const userDocRef = db.collection(`Class-${classId}`).doc(user.uid);
        const userDoc = await userDocRef.get();
        
        if (userDoc.exists && userDoc.data().payments && userDoc.data().payments.length > 0) {
          const allPayments = userDoc.data().payments;
          allPayments.sort((a, b) => b.date.toDate().getTime() - a.date.toDate().getTime());
          const latestPayment = allPayments[0];

          receiptInfoDiv.innerHTML = `
            <p><strong>Payment ID:</strong> ${latestPayment.paymentId || 'N/A'}</p>
            <p><strong>Order ID:</strong> ${latestPayment.orderId || 'N/A'}</p>
            <p><strong>Amount:</strong> ₹${(latestPayment.amount / 100).toFixed(2) || 'N/A'} ${latestPayment.currency || ''}</p>
            <p><strong>Date Paid:</strong> ${latestPayment.date ? latestPayment.date.toDate().toLocaleDateString() : 'N/A'}</p>
            <p><strong>For Month:</strong> ${latestPayment.month || 'N/A'} ${latestPayment.year || ''}</p>
            <p><strong>Status:</strong> <span class="text-green-600">${latestPayment.status || 'N/A'}</span></p>
          `;
        } else {
          receiptInfoDiv.innerHTML = `<p><strong>No payment records found.</strong></p>`;
        }
        lastReceiptModal.classList.remove('hidden');
      }
    });

    closeLastReceiptModalBtn.addEventListener('click', () => {
      lastReceiptModal.classList.add('hidden');
    });

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduLearn - Your Online Classroom</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Jitsi Meet API for Live Classes -->
    <script src='https://meet.jit.si/external_api.js'></script>

    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .view {
            display: none;
        }
        .active-view {
            display: block;
        }
        /* Simple transition for view changes */
        .view-transition {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 28rem;
            position: relative;
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Main Container -->
    <div id="app-container" class="min-h-screen">

        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-50">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="#" class="text-2xl font-bold text-indigo-600">
                    <i class="fas fa-book-open-reader mr-2"></i>EduLearn
                </a>
                <div>
                    <button id="sign-in-nav-btn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">
                        Sign In
                    </button>
                    <button id="logout-btn" class="hidden bg-red-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300">
                        Logout
                    </button>
                </div>
            </nav>
        </header>
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center hidden">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600"></div>
        </div>


        <!-- ===== VIEWS ===== -->

        <!-- Home/Public Dashboard View -->
        <main id="home-view" class="view active-view p-4 md:p-8">
            <div class="container mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-8 mb-8 text-center">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">Welcome to Your Digital Classroom</h1>
                    <p class="text-lg text-gray-600 mb-6 max-w-2xl mx-auto">Empowering students and teachers with the tools for modern, collaborative learning.</p>
                    <blockquote class="border-l-4 border-indigo-500 pl-4 italic text-gray-500">
                        "The beautiful thing about learning is that nobody can take it away from you." â€“ B.B. King
                    </blockquote>
                </div>

                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Contacts Card -->
                    <div id="card-contacts" class="card-action bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 cursor-pointer">
                        <i class="fas fa-address-book text-3xl text-indigo-500 mb-4"></i>
                        <h3 class="font-bold text-xl mb-2">Contacts</h3>
                        <p class="text-gray-600">Get in touch with our administration and support staff.</p>
                    </div>
                    <!-- Help & Support Card -->
                    <div id="card-help" class="card-action bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 cursor-pointer">
                        <i class="fas fa-life-ring text-3xl text-green-500 mb-4"></i>
                        <h3 class="font-bold text-xl mb-2">Help & Support</h3>
                        <p class="text-gray-600">Find answers to your questions and technical support.</p>
                    </div>
                    <!-- Our Teachers Card -->
                    <div id="card-teachers" class="card-action bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 cursor-pointer">
                        <i class="fas fa-users text-3xl text-blue-500 mb-4"></i>
                        <h3 class="font-bold text-xl mb-2">Our Teachers</h3>
                        <p class="text-gray-600">Meet our team of dedicated and experienced educators.</p>
                    </div>
                    <!-- Demo Quizzes Card -->
                    <div id="card-quizzes" class="card-action bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 cursor-pointer">
                        <i class="fas fa-puzzle-piece text-3xl text-yellow-500 mb-4"></i>
                        <h3 class="font-bold text-xl mb-2">Demo Quizzes</h3>
                        <p class="text-gray-600">Try out some sample quizzes to test your knowledge.</p>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Auth Modal -->
        <div id="auth-modal" class="modal">
            <div class="modal-content view-transition w-full max-w-md">
                <button id="close-auth-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                
                <!-- Sign In Form -->
                <div id="sign-in-form-container" class="p-8">
                    <h2 class="text-3xl font-bold text-center mb-6">Sign In</h2>
                    <form id="sign-in-form">
                        <div class="mb-4">
                            <label for="signin-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                            <input type="email" id="signin-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="signin-password" class="block text-gray-700 font-semibold mb-2">Password</label>
                            <input type="password" id="signin-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-300">Sign In</button>
                    </form>
                    <div class="my-4 text-center text-gray-500">OR</div>
                    <button id="google-signin-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-100 transition duration-300 flex items-center justify-center">
                        <i class="fab fa-google mr-2"></i> Sign In with Google
                    </button>
                    <p class="mt-6 text-center">Don't have an account? <a href="#" id="show-register-form" class="text-indigo-600 hover:underline font-semibold">Register now</a></p>
                </div>

                <!-- Register Form -->
                <div id="register-form-container" class="p-8 hidden">
                    <h2 class="text-3xl font-bold text-center mb-6">Register as a Student</h2>
                    <form id="register-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                             <label for="register-name" class="block text-gray-700 font-semibold mb-1 text-sm">Student's Name</label>
                            <input type="text" id="register-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                         <div>
                            <label for="register-father-name" class="block text-gray-700 font-semibold mb-1 text-sm">Father's Name</label>
                            <input type="text" id="register-father-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="register-contact" class="block text-gray-700 font-semibold mb-1 text-sm">Contact No.</label>
                            <input type="tel" id="register-contact" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="register-address" class="block text-gray-700 font-semibold mb-1 text-sm">Address</label>
                            <input type="text" id="register-address" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="register-zip" class="block text-gray-700 font-semibold mb-1 text-sm">ZIP Code</label>
                            <input type="text" id="register-zip" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="register-school" class="block text-gray-700 font-semibold mb-1 text-sm">School</label>
                            <input type="text" id="register-school" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="register-class" class="block text-gray-700 font-semibold mb-1 text-sm">Class</label>
                            <select id="register-class" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" required>
                                <option value="V">Class - V</option>
                                <option value="VI">Class - VI</option>
                                <option value="VII">Class - VII</option>
                                <option value="VIII">Class - VIII</option>
                                <option value="IX">Class - IX</option>
                                <option value="X">Class - X</option>
                                <option value="XI">Class - XI</option>
                                <option value="XII">Class - XII</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                             <label for="register-email" class="block text-gray-700 font-semibold mb-1 text-sm">Email</label>
                            <input type="email" id="register-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                         <div class="md:col-span-2">
                            <label for="register-password" class="block text-gray-700 font-semibold mb-1 text-sm">Password</label>
                            <input type="password" id="register-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="md:col-span-2">
                           <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-300">Register</button>
                        </div>
                    </form>
                    <p class="mt-6 text-center">Already have an account? <a href="#" id="show-signin-form" class="text-indigo-600 hover:underline font-semibold">Sign In</a></p>
                </div>
            </div>
        </div>

        <!-- Student Dashboard View -->
        <div id="student-dashboard-view" class="view p-4 md:p-8">
            <div class="container mx-auto">
                <h1 class="text-3xl font-bold mb-2">Welcome, <span id="student-name"></span>!</h1>
                <p class="text-lg text-gray-600 mb-6">You are in <span id="student-class" class="font-semibold"></span>. Here's your dashboard.</p>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Live Class Section -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">Live Class</h2>
                        <div id="class-status" class="mb-4 p-4 rounded-lg text-center">
                            <!-- Status updated by JS -->
                        </div>
                        <button id="join-class-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-video mr-2"></i> Join Class
                        </button>
                        <div id="jitsi-container-student" class="mt-4 w-full h-96 rounded-lg overflow-hidden hidden"></div>
                         <button id="leave-class-btn-student" class="hidden w-full mt-4 bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition duration-300">
                            Leave Class
                        </button>
                    </div>

                    <!-- Resources Section -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">Class Resources</h2>
                        <div id="resources-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Resources will be populated by JS -->
                             <p class="text-center text-gray-500">No resources available yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Dashboard View -->
        <div id="teacher-dashboard-view" class="view p-4 md:p-8">
            <div class="container mx-auto">
                <h1 class="text-3xl font-bold mb-6">Teacher Dashboard</h1>
                 <p class="text-lg text-gray-600 mb-6">Welcome, <span id="teacher-name" class="font-semibold"></span>! Select a class to manage.</p>
                <div id="teacher-class-grid" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- Class cards will be populated by JS -->
                </div>
            </div>
        </div>
        
        <!-- Teacher Class Management View -->
        <div id="teacher-class-management-view" class="view p-4 md:p-8">
             <div class="container mx-auto">
                <button id="back-to-teacher-dashboard" class="mb-6 bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </button>
                <h1 class="text-3xl font-bold mb-6">Manage <span id="manage-class-name" class="text-indigo-600"></span></h1>
                
                 <div class="grid md:grid-cols-2 gap-8">
                    <!-- Live Class Control -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">Live Class Control</h2>
                        <button id="start-class-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition duration-300">
                           <i class="fas fa-play-circle mr-2"></i> Start Class
                        </button>
                         <button id="end-class-btn" class="hidden w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition duration-300">
                           <i class="fas fa-stop-circle mr-2"></i> End Class
                        </button>
                        <div id="jitsi-container-teacher" class="mt-4 w-full h-96 rounded-lg overflow-hidden hidden"></div>
                    </div>

                    <!-- Manage Resources -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">Manage Resources</h2>
                        <form id="resource-upload-form" class="mb-6 space-y-4">
                            <div>
                                <label for="resource-title" class="block text-gray-700 font-semibold mb-1 text-sm">Resource Title</label>
                                <input type="text" id="resource-title" placeholder="e.g., Chapter 5 Notes" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="resource-link" class="block text-gray-700 font-semibold mb-1 text-sm">Google Drive Link</label>
                                <input type="url" id="resource-link" placeholder="https://docs.google.com/..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">
                                <i class="fas fa-upload mr-2"></i> Upload Resource
                            </button>
                        </form>
                        <h3 class="font-bold text-lg mb-2">Uploaded Resources</h3>
                        <div id="teacher-resources-list" class="space-y-3 max-h-60 overflow-y-auto">
                            <p class="text-center text-gray-500">No resources uploaded yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ===== MODALS FOR HOME PAGE CARDS ===== -->
        
        <!-- Contacts Modal -->
        <div id="contacts-modal" class="modal">
            <div class="modal-content p-6">
                <button class="close-modal absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" data-modal-id="contacts-modal">&times;</button>
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Admin Contacts</h2>
                <div class="space-y-4">
                    <div class="flex items-center p-3 bg-green-50 rounded-lg">
                        <i class="fab fa-whatsapp text-green-500 text-3xl mr-4"></i>
                        <div>
                            <p class="font-semibold text-gray-700">WhatsApp Support</p>
                            <a href="https://wa.me/9999999999" target="_blank" class="text-green-600 hover:underline">
                                Coming Soon
                            </a>
                        </div>
                    </div>
                    <div class="flex items-center p-3 bg-red-50 rounded-lg">
                        <i class="fas fa-envelope text-red-500 text-3xl mr-4"></i>
                        <div>
                            <p class="font-semibold text-gray-700">Email Support</p>
                            <a href="mailto:learner.studenthub@gmail.com" class="text-red-600 hover:underline">
                                Click to mail us
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Help & Support Modal -->
        <div id="help-modal" class="modal">
            <div class="modal-content p-6">
                <button class="close-modal absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" data-modal-id="help-modal">&times;</button>
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Need Help?</h2>
                <form id="support-form" class="space-y-4">
                    <div>
                        <label for="support-name" class="block text-gray-700 font-semibold mb-1 text-sm">Your Name</label>
                        <input type="text" id="support-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="support-contact" class="block text-gray-700 font-semibold mb-1 text-sm">Mobile/WhatsApp No.</label>
                        <input type="text" id="support-contact" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="support-issue" class="block text-gray-700 font-semibold mb-1 text-sm">Describe Your Issue</label>
                        <textarea id="support-issue" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., I cannot log in or a class resource link is broken." required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition">
                        Submit Issue
                    </button>
                    <p id="support-message" class="text-center text-sm text-green-700 hidden">Thank you! Your issue has been submitted and we will contact you shortly.</p>
                </form>
            </div>
        </div>
        
        <!-- Our Teachers Modal -->
        <div id="teachers-modal" class="modal">
            <div class="modal-content p-6">
                <button class="close-modal absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" data-modal-id="teachers-modal">&times;</button>
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Meet Our Educators</h2>
                <div class="space-y-6 max-h-96 overflow-y-auto pr-2">
                    <!-- Dummy Teacher 1 -->
                    <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl shadow-sm">
                        <div class="w-16 h-16 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 text-sm font-semibold flex-shrink-0">
                            Photo Placeholder
                        </div>
                        <div>
                            <p class="font-bold text-lg">Ms. Susmita Roy</p>
                            <p class="text-indigo-600 font-medium">English</p>
                            <p class="text-sm text-gray-500">Classes V - XII</p>
                        </div>
                    </div>
                    <!-- Dummy Teacher 2 -->
                    <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl shadow-sm">
                         <div class="w-16 h-16 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 text-sm font-semibold flex-shrink-0">
                            Photo Placeholder
                        </div>
                        <div>
                            <p class="font-bold text-lg">Mr. Biswajit Maity</p>
                            <p class="text-indigo-600 font-medium">Engliash</p>
                            <p class="text-sm text-gray-500">Classes v - X</p>
                        </div>
                    </div>
                    <!-- Dummy Teacher 3 -->
                    <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl shadow-sm">
                        <div class="w-16 h-16 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 text-sm font-semibold flex-shrink-0">
                            Photo Placeholder
                        </div>
                        <div>
                            <p class="font-bold text-lg">Dr. Sumit Das</p>
                            <p class="text-indigo-600 font-medium">Science & Physics</p>
                            <p class="text-sm text-gray-500">Classes V - XII</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Demo Quizzes Modal -->
        <div id="quizzes-modal" class="modal">
            <div class="modal-content p-6">
                <button class="close-modal absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" data-modal-id="quizzes-modal">&times;</button>
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Take a Demo Quiz</h2>
                <form id="demo-quiz-form" class="space-y-4">
                    <div>
                        <label for="quiz-class" class="block text-gray-700 font-semibold mb-1 text-sm">Select Class</label>
                        <select id="quiz-class" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" required>
                            <option value="">-- Choose Class --</option>
                            <option value="V">Class - V</option>
                            <option value="X">Class - X</option>
                            <option value="XII">Class - XII</option>
                        </select>
                    </div>
                    <div>
                        <label for="quiz-subject" class="block text-gray-700 font-semibold mb-1 text-sm">Select Subject</label>
                        <select id="quiz-subject" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" required>
                             <option value="">-- Choose Subject --</option>
                             <option value="Math">Math</option>
                             <option value="Science">Science</option>
                             <option value="English">English</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-yellow-500 text-white font-bold py-3 rounded-lg hover:bg-yellow-600 transition">
                        <i class="fas fa-arrow-right mr-2"></i> Start Quiz
                    </button>
                    <div id="quiz-link-placeholder" class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded hidden">
                        <p class="font-semibold text-yellow-800 mb-2">Quiz Link Placeholder</p>
                        <p class="text-sm text-yellow-700">The link below simulates the start of a quiz. Replace this text with your actual quiz URL (e.g., a Google Forms link) in the future.</p>
                        <a id="final-quiz-link" href="#" target="_blank" class="block text-yellow-600 font-medium hover:underline mt-2">
                           Click Here to Access Quiz
                        </a>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            addDoc,
            query,
            onSnapshot,
            serverTimestamp,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        // Add debug logging to trace permissions issues
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        setLogLevel('debug');


        // --- Firebase Configuration (UPDATED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyApjKA34mwvz_gWH9V0RY4wHbmMEP6oqRg",
            authDomain: "educonnectapp-ae08d.firebaseapp.com",
            projectId: "educonnectapp-ae08d",
            storageBucket: "educonnectapp-ae08d.firebasestorage.app",
            messagingSenderId: "10974354104",
            appId: "1:10974354104:web:228ca789dfb241f43ff24d"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let currentUser = null;
        let userData = null;
        let currentClassUnsubscribe = null;
        let currentResourcesUnsubscribe = null;
        let jitsiApi = null;
        let currentManagedClass = null;

        // DOM Elements
        const views = document.querySelectorAll('.view');
        const authModal = document.getElementById('auth-modal');
        const loadingSpinner = document.getElementById('loading-spinner');

        const signInNavBtn = document.getElementById('sign-in-nav-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const closeAuthModalBtn = document.getElementById('close-auth-modal');
        const showRegisterFormBtn = document.getElementById('show-register-form');
        const showSigninFormBtn = document.getElementById('show-signin-form');

        const signInForm = document.getElementById('sign-in-form');
        const registerForm = document.getElementById('register-form');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        
        const signInFormContainer = document.getElementById('sign-in-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        
        const modalElements = document.querySelectorAll('.modal');

        // --- UI HELPER FUNCTIONS ---
        
        const showSpinner = () => loadingSpinner.classList.remove('hidden');
        const hideSpinner = () => loadingSpinner.classList.add('hidden');
        
        const showView = (viewId) => {
            views.forEach(view => view.classList.remove('active-view', 'view-transition'));
            const viewToShow = document.getElementById(viewId);
            if(viewToShow) {
                viewToShow.classList.add('active-view', 'view-transition');
            }
        };

        const showAlert = (message, isError = false) => {
            // A simple alert for demonstration. In a real app, use a modal.
            console.error(isError ? `ERROR: ${message}` : `INFO: ${message}`);
            alert(message);
        };
        
        const showModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        };

        const hideModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // --- EVENT LISTENERS FOR NEW MODALS ---

        document.getElementById('card-contacts').addEventListener('click', () => showModal('contacts-modal'));
        document.getElementById('card-help').addEventListener('click', () => showModal('help-modal'));
        document.getElementById('card-teachers').addEventListener('click', () => showModal('teachers-modal'));
        document.getElementById('card-quizzes').addEventListener('click', () => showModal('quizzes-modal'));

        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modalId || e.target.parentElement.dataset.modalId;
                if (modalId) hideModal(modalId);
            });
        });
        
        document.getElementById('support-form').addEventListener('submit', (e) => {
            e.preventDefault();
            // In a real application, you would send this data to Firestore or a backend service.
            // For now, we simulate submission feedback.
            document.getElementById('support-form').reset();
            document.getElementById('support-message').classList.remove('hidden');
            setTimeout(() => {
                 document.getElementById('support-message').classList.add('hidden');
                 hideModal('help-modal');
            }, 3000);
        });
        
        document.getElementById('demo-quiz-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedClass = document.getElementById('quiz-class').value;
            const selectedSubject = document.getElementById('quiz-subject').value;
            
            if (selectedClass && selectedSubject) {
                // Construct a dummy quiz link based on selection
                const dummyLink = `https://forms.google.com/quiz/${selectedClass}-${selectedSubject}-demo`;
                document.getElementById('final-quiz-link').href = dummyLink;
                document.getElementById('final-quiz-link').textContent = `Start ${selectedSubject} Quiz for Class ${selectedClass}`;
                document.getElementById('quiz-link-placeholder').classList.remove('hidden');
            } else {
                 document.getElementById('quiz-link-placeholder').classList.add('hidden');
                 showAlert("Please select both class and subject to start the demo quiz.", true);
            }
        });


        // --- AUTHENTICATION ---

        onAuthStateChanged(auth, async (user) => {
            showSpinner();
            if (user) {
                currentUser = user;
                // Check for user data immediately after auth state change
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    userData = userDoc.data();
                    updateUIForUser();
                } else {
                    // This handles Google sign-in for the first time or registration with no extra data
                    // If a user is authenticated but no profile exists, create a default one
                    // to prevent permission denied errors on other collections.
                    userData = {
                        email: user.email,
                        name: user.displayName || 'New User',
                        role: 'student', // Default role
                        class: 'V' // Default class
                    };
                    await setDoc(userDocRef, userData, { merge: true }); // Use merge: true to avoid overwriting display name if it exists
                    showAlert("Welcome! Default profile created. Please update your class information.", false);
                    updateUIForUser();
                }
            } else {
                currentUser = null;
                userData = null;
                updateUIForUser();
            }
            hideSpinner();
        });

        const updateUIForUser = () => {
            if (currentUser && userData) {
                signInNavBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                authModal.style.display = 'none';

                if (userData.role === 'student') {
                    showView('student-dashboard-view');
                    setupStudentDashboard();
                } else if (userData.role === 'teacher') {
                    showView('teacher-dashboard-view');
                    setupTeacherDashboard();
                }
            } else {
                signInNavBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                showView('home-view');
                if (currentClassUnsubscribe) currentClassUnsubscribe();
                if (currentResourcesUnsubscribe) currentResourcesUnsubscribe();
            }
        };
        
        // Sign In/Up/Out Logic
        signInForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showSpinner();
            const email = signInForm['signin-email'].value;
            const password = signInForm['signin-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showAlert(`Error: ${error.message}`, true);
            } finally {
                hideSpinner();
            }
        });

        googleSignInBtn.addEventListener('click', async () => {
            showSpinner();
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                showAlert(`Error: ${error.message}`, true);
            } finally {
                hideSpinner();
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showSpinner();
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            const studentData = {
                name: registerForm['register-name'].value,
                fatherName: registerForm['register-father-name'].value,
                address: registerForm['register-address'].value,
                contact: registerForm['register-contact'].value,
                zip: registerForm['register-zip'].value,
                school: registerForm['register-school'].value,
                class: registerForm['register-class'].value,
                role: 'student',
                email: email
            };

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), studentData);
                showAlert("Registration successful!", false);
            } catch (error) {
                showAlert(`Error: ${error.message}`, true);
            } finally {
                hideSpinner();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            showSpinner();
            if (jitsiApi) {
                jitsiApi.dispose();
                jitsiApi = null;
            }
            await signOut(auth);
            hideSpinner();
        });

        // Auth Modal UI
        signInNavBtn.addEventListener('click', () => authModal.style.display = 'flex');
        closeAuthModalBtn.addEventListener('click', () => authModal.style.display = 'none');
        showRegisterFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            signInFormContainer.classList.add('hidden');
            registerFormContainer.classList.remove('hidden');
        });
        showSigninFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            registerFormContainer.classList.add('hidden');
            signInFormContainer.classList.remove('hidden');
        });
        
        // --- STUDENT DASHBOARD ---

        const setupStudentDashboard = () => {
            document.getElementById('student-name').textContent = userData.name;
            document.getElementById('student-class').textContent = `Class ${userData.class}`;

            const classStatusEl = document.getElementById('class-status');
            const joinClassBtn = document.getElementById('join-class-btn');

            if (currentClassUnsubscribe) currentClassUnsubscribe();
            currentClassUnsubscribe = onSnapshot(doc(db, "live_classes", userData.class), (docSnap) => {
                if (docSnap.exists() && docSnap.data().isLive) {
                    classStatusEl.innerHTML = `<p class="bg-green-100 text-green-800 p-3 rounded-lg font-semibold">Class is Live! Join now.</p>`;
                    joinClassBtn.disabled = false;
                    joinClassBtn.dataset.room = docSnap.data().roomName;
                } else {
                    classStatusEl.innerHTML = `<p class="bg-yellow-100 text-yellow-800 p-3 rounded-lg font-semibold">No live class is running currently.</p>`;
                    joinClassBtn.disabled = true;
                    if(jitsiApi) {
                        jitsiApi.dispose();
                        jitsiApi = null;
                        document.getElementById('jitsi-container-student').classList.add('hidden');
                         document.getElementById('leave-class-btn-student').classList.add('hidden');
                    }
                }
            });

            const resourcesList = document.getElementById('resources-list');
            // The query path now includes the classId, which is used in the security rules for validation
            const resourcesQuery = query(collection(db, "resources", userData.class, "links")); 
            
            if (currentResourcesUnsubscribe) currentResourcesUnsubscribe();
            currentResourcesUnsubscribe = onSnapshot(resourcesQuery, (snapshot) => {
                if (snapshot.empty) {
                    resourcesList.innerHTML = `<p class="text-center text-gray-500">No resources available yet.</p>`;
                    return;
                }
                resourcesList.innerHTML = '';
                snapshot.forEach(doc => {
                    const resource = doc.data();
                    const resourceEl = document.createElement('a');
                    resourceEl.href = resource.url;
                    resourceEl.target = '_blank';
                    resourceEl.className = 'block p-4 bg-gray-100 rounded-lg hover:bg-indigo-100 transition duration-300';
                    resourceEl.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-link text-indigo-500 mr-4"></i>
                            <div>
                                <p class="font-semibold text-gray-800">${resource.title}</p>
                                <p class="text-sm text-gray-500">${resource.url.substring(0, 40)}...</p>
                            </div>
                        </div>
                    `;
                    resourcesList.appendChild(resourceEl);
                });
            }, (error) => {
                // Log snapshot errors
                console.error("Resources Snapshot Error:", error);
            });
        };
        
        document.getElementById('join-class-btn').addEventListener('click', () => {
            const roomName = document.getElementById('join-class-btn').dataset.room;
            if (roomName) {
                const domain = 'meet.jit.si';
                const options = {
                    roomName: roomName,
                    width: '100%',
                    height: '100%',
                    parentNode: document.querySelector('#jitsi-container-student'),
                    userInfo: {
                        displayName: userData.name
                    },
                    configOverwrite: { prejoinPageEnabled: false },
                    interfaceConfigOverwrite: { TOOLBAR_BUTTONS: [ 'microphone', 'camera', 'chat', 'tileview', 'fullscreen', 'hangup'] }
                };
                jitsiApi = new JitsiMeetExternalAPI(domain, options);
                document.getElementById('jitsi-container-student').classList.remove('hidden');
                document.getElementById('leave-class-btn-student').classList.remove('hidden');
            }
        });
        
        document.getElementById('leave-class-btn-student').addEventListener('click', () => {
            if(jitsiApi) {
                jitsiApi.dispose();
                jitsiApi = null;
                document.getElementById('jitsi-container-student').classList.add('hidden');
                document.getElementById('leave-class-btn-student').classList.add('hidden');
            }
        });

        // --- TEACHER DASHBOARD ---

        const setupTeacherDashboard = () => {
            document.getElementById('teacher-name').textContent = userData.name;
            const classGrid = document.getElementById('teacher-class-grid');
            const classes = ["V", "VI", "VII", "VIII", "IX", "X", "XI", "XII"];
            classGrid.innerHTML = '';
            classes.forEach(className => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:bg-indigo-50 transition-all duration-300 cursor-pointer text-center';
                card.innerHTML = `<h3 class="text-2xl font-bold text-indigo-700">Class ${className}</h3>`;
                card.addEventListener('click', () => {
                    currentManagedClass = className;
                    setupClassManagementView(className);
                });
                classGrid.appendChild(card);
            });
        };

        const setupClassManagementView = (className) => {
            showView('teacher-class-management-view');
            document.getElementById('manage-class-name').textContent = `Class ${className}`;

            const startClassBtn = document.getElementById('start-class-btn');
            const endClassBtn = document.getElementById('end-class-btn');

            // Check if a class is already live for this teacher/class
            const liveClassRef = doc(db, "live_classes", className);
            getDoc(liveClassRef).then(docSnap => {
                if(docSnap.exists() && docSnap.data().isLive) {
                    startClassBtn.classList.add('hidden');
                    endClassBtn.classList.remove('hidden');
                } else {
                    startClassBtn.classList.remove('hidden');
                    endClassBtn.classList.add('hidden');
                }
            });
            
            // Fetch and display resources for this class
            const resourcesList = document.getElementById('teacher-resources-list');
            const resourcesQuery = query(collection(db, "resources", className, "links"));
            if (currentResourcesUnsubscribe) currentResourcesUnsubscribe();
            currentResourcesUnsubscribe = onSnapshot(resourcesQuery, (snapshot) => {
                 if (snapshot.empty) {
                    resourcesList.innerHTML = `<p class="text-center text-gray-500">No resources uploaded yet.</p>`;
                    return;
                }
                resourcesList.innerHTML = '';
                snapshot.forEach(doc => {
                    const resource = doc.data();
                    const resourceEl = document.createElement('div');
                    resourceEl.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    resourceEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${resource.title}</p>
                            <a href="${resource.url}" target="_blank" class="text-sm text-blue-500 hover:underline">${resource.url.substring(0, 30)}...</a>
                        </div>
                        <button data-id="${doc.id}" class="delete-resource-btn text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                    `;
                    resourcesList.appendChild(resourceEl);
                });
                
                // Attach delete listeners (must be done after list is populated)
                document.querySelectorAll('.delete-resource-btn').forEach(btn => {
                    btn.onclick = (e) => deleteResource(e.currentTarget.dataset.id);
                });

            }, (error) => {
                // Log snapshot errors
                console.error("Teacher Resources Snapshot Error:", error);
            });
        };
        
        document.getElementById('back-to-teacher-dashboard').addEventListener('click', () => {
            showView('teacher-dashboard-view');
            if (currentResourcesUnsubscribe) currentResourcesUnsubscribe();
            currentManagedClass = null;
        });

        // Live Class controls for teacher
        document.getElementById('start-class-btn').addEventListener('click', async () => {
            showSpinner();
            const roomName = `EduLearn-${currentManagedClass}-${Date.now()}`;
            const liveClassData = {
                isLive: true,
                roomName: roomName,
                teacherName: userData.name
            };
            try {
                // Create/Update the live_classes document
                await setDoc(doc(db, "live_classes", currentManagedClass), liveClassData);
                document.getElementById('start-class-btn').classList.add('hidden');
                document.getElementById('end-class-btn').classList.remove('hidden');

                const domain = 'meet.jit.si';
                const options = {
                    roomName: roomName,
                    width: '100%',
                    height: '100%',
                    parentNode: document.querySelector('#jitsi-container-teacher'),
                    userInfo: { displayName: `Teacher - ${userData.name}` },
                    configOverwrite: { prejoinPageEnabled: false },
                };
                jitsiApi = new JitsiMeetExternalAPI(domain, options);
                document.getElementById('jitsi-container-teacher').classList.remove('hidden');
            } catch(error) {
                 showAlert(`Error starting class: ${error.message}`, true);
            } finally {
                hideSpinner();
            }
        });

        document.getElementById('end-class-btn').addEventListener('click', async () => {
            showSpinner();
             try {
                // Deleting the document marks the class as ended
                await deleteDoc(doc(db, "live_classes", currentManagedClass));
                document.getElementById('start-class-btn').classList.remove('hidden');
                document.getElementById('end-class-btn').classList.add('hidden');
                if(jitsiApi) {
                    jitsiApi.dispose();
                    jitsiApi = null;
                }
                document.getElementById('jitsi-container-teacher').classList.add('hidden');
            } catch(error) {
                 showAlert(`Error ending class: ${error.message}`, true);
            } finally {
                hideSpinner();
            }
        });

        // Resource management for teacher
        document.getElementById('resource-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showSpinner();
            const title = document.getElementById('resource-title').value;
            const url = document.getElementById('resource-link').value;

            try {
                await addDoc(collection(db, "resources", currentManagedClass, "links"), {
                    title: title,
                    url: url,
                    uploadedAt: serverTimestamp()
                });
                document.getElementById('resource-upload-form').reset();
                showAlert("Resource uploaded successfully!", false);
            } catch(error) {
                showAlert(`Error uploading resource: ${error.message}`, true);
            } finally {
                hideSpinner();
            }
        });
        
        const deleteResource = async (docId) => {
            // Confirmation logic is skipped per instructions, proceeding to delete
            showSpinner();
            try {
                await deleteDoc(doc(db, "resources", currentManagedClass, "links", docId));
                showAlert("Resource deleted.", false);
            } catch (error) {
                showAlert(`Error deleting resource: ${error.message}`, true);
            } finally {
                hideSpinner();
            }
        };

    </script>
</body>
</html>

